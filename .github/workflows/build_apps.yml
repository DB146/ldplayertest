name: Build Multiple Package Apps

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build APKs from list
        run: |
          # Create a directory to store the outputs
          mkdir -p generated_apks
          
          # Read the packages.txt file line by line
          while IFS= read -r package_name || [ -n "$package_name" ]; do
            # Skip empty lines
            if [ -z "$package_name" ]; then continue; fi
            
            echo "Building app for package: $package_name"
            
            # Run Gradle build
            # We pass -PcustomPackage to set applicationId
            # We pass -PcustomName to set the app label
            ./gradlew app:assembleDebug \
              -PcustomPackage="$package_name" \
              -PcustomName="$package_name"
            
            # Move and rename the APK to the output folder
            # Assuming standard output path
            mv app/build/outputs/apk/debug/app-debug.apk "generated_apks/${package_name}.apk"
            
            # Clean only the build output to ensure next build picks up changes
            ./gradlew app:clean
            
          done < packages.txt

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: multiple-apps-bundle
          path: generated_apks/*.apk
          if-no-files-found: error
